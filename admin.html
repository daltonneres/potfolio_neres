<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Gerenciador de Leads</title>
    <link rel="icon" href="favicon.svg" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-body { padding: 40px; background: #000; color: white; }
        .header-admin { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #3498db; padding-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; background: #111; }
        th, td { text-align: left; padding: 15px; border-bottom: 1px solid #222; }
        th { background: #3498db; color: #000; }
        .badge { padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .badge-visita { background: #555; color: white; }
        .badge-interesse { background: #27ae60; color: white; }
/* Situa√ß√£o */
.status-novo {
  color: #f39c12;
  font-weight: bold;
}

.status-contato {
  color: #3498db;
  font-weight: bold;
}

.status-concluido {
  color: #2ecc71;
  font-weight: bold;
}

/* Menu de a√ß√µes */
.dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-btn {
  background: #222;
  color: #fff;
  border: 1px solid #3498db;
  padding: 6px 10px;
  cursor: pointer;
  font-size: 13px;
}

.dropdown-content {
  display: none;
  position: absolute;
  background: #111;
  min-width: 180px;
  box-shadow: 0 0 10px rgba(0,0,0,0.5);
  z-index: 999;
}

.dropdown-content button {
  width: 100%;
  background: none;
  border: none;
  color: #fff;
  padding: 10px;
  text-align: left;
  cursor: pointer;
}

.dropdown-content button:hover {
  background: #3498db;
  color: #000;
}

.dropdown:hover .dropdown-content {
  display: block;
}

.status-sem-retorno {
  color: #e74c3c;
  font-weight: bold;
}

    </style>
</head>
<body class="admin-body">
    <div class="header-admin">
        <h1>Leads do Portf√≥lio</h1>

        <div style="display: flex; gap: 10px;">
            <a href="index.html" class="btn-secondary" style="padding: 10px 20px; text-decoration: none;">
                In√≠cio
            </a>
            <button onclick="abrirModalLead()" class="btn-secondary" style="padding: 10px 20px;">
  Novo lead (manual)
</button>
<button onclick="alternarArquivados()" class="btn-secondary" style="padding: 10px 20px;">
  Arquivados
</button>
            <button onclick="logout()" class="btn-secondary" style="padding: 10px 20px;">
                Sair
            </button>
        </div>
    </div>

    <table id="tabelaLeads">
<thead>
  <tr>
    <th>Data</th>
    <th>Nome</th>
    <th>Status/Tipo</th>
    <th>WhatsApp</th>
    <th>Situa√ß√£o</th>
    <th>A√ß√µes</th>
  </tr>
</thead>
        <tbody>
            </tbody>
    </table>

    <script type="module">
      let mostrandoArquivados = false;
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  getDoc,
  query,
  orderBy,
  onSnapshot,
  doc,
  deleteDoc,
  updateDoc,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD-7iM7QKN8bKYY8CLm4df8wbyA1qvUZxw",
            authDomain: "leadsportfolio-c4815.firebaseapp.com",
            projectId: "leadsportfolio-c4815",
            storageBucket: "leadsportfolio-c4815.firebasestorage.app",
            messagingSenderId: "293134787082",
            appId: "1:293134787082:web:73d7343134325733f2b5f3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Prote√ß√£o de Rota
        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "login.html";
        });

        window.logout = () => {
            signOut(auth).then(() => window.location.href = "login.html");
        };

        // Carregar Leads em Tempo Real
const getQuery = () => {
  return mostrandoArquivados
    ? query(collection(db, "leads_arquivados"), orderBy("dataCriacao", "desc"))
    : query(collection(db, "leads"), orderBy("dataCriacao", "desc"));
};

let unsubscribe;

const carregarLeads = () => {
  if (unsubscribe) unsubscribe();

  unsubscribe = onSnapshot(getQuery(), (snapshot) => {
    const tbody = document.querySelector("#tabelaLeads tbody");
    tbody.innerHTML = "";

    snapshot.forEach((docSnap) => {
      const lead = docSnap.data();
      const id = docSnap.id;

      const data = lead.dataCriacao?.toDate().toLocaleString("pt-BR") || "Aguardando...";
      const classeBadge = lead.tipo === "Interesse" ? "badge-interesse" : "badge-visita";

      const situacao = lead.situacao || "Novo";
      let classeSituacao = "status-novo";
      if (situacao === "Em contato") classeSituacao = "status-contato";
      if (situacao === "Conclu√≠do") classeSituacao = "status-concluido";
      if (situacao === "Conclu√≠do sem retorno") classeSituacao = "status-sem-retorno";

      tbody.innerHTML += `
        <tr>
          <td>${data}</td>
          <td>${lead.nome}</td>
          <td><span class="badge ${classeBadge}">${lead.tipo}</span></td>
          <td>${lead.telefone || "---"}</td>
          <td class="${classeSituacao}">${situacao}</td>
          <td>
            <div class="dropdown">
              <button class="dropdown-btn">A√ß√µes</button>
              <div class="dropdown-content">
                ${!mostrandoArquivados ? `
                  <button onclick="chamarWhats('${lead.telefone}', '${lead.nome}', '${id}')">
                    Chamar no WhatsApp
                  </button>
                  <button onclick="marcarContato('${id}')">Marcar como Em contato</button>
                  <button onclick="concluirLead('${id}')">Marcar como Conclu√≠do</button>
                  <button onclick="concluirSemRetorno('${id}')">Conclu√≠do sem retorno</button>
                ` : `
                  <button onclick="restaurarLead('${id}')">Restaurar atendimento</button>
                `}
                <button onclick="excluirLead('${id}', ${mostrandoArquivados})">
                  Excluir definitivamente
                </button>
              </div>
            </div>
          </td>
        </tr>
      `;
    });
  });
};

carregarLeads();

// WhatsApp
window.chamarWhats = (telefone, nome, id) => {
  if (!telefone) return alert("Telefone n√£o informado");

  const msg = encodeURIComponent(
    `Ol√° ${nome}, tudo bem? üòä\nSou o Dalton, estou entrando em contato sobre seu atendimento.`
  );

  window.open(`https://wa.me/55${telefone}?text=${msg}`, "_blank");
  marcarContato(id);
};

// Marcar como Em contato
window.marcarContato = async (id) => {
  await updateDoc(doc(db, "leads", id), { situacao: "Em contato" });
};

// Concluir
window.concluirLead = async (id) => {
  await updateDoc(doc(db, "leads", id), { situacao: "Conclu√≠do" });
};

// Excluir
window.excluirLead = async (id) => {
  if (!confirm("Deseja realmente excluir este atendimento?")) return;
  await deleteDoc(doc(db, "leads", id));
};

window.abrirModalLead = () => {
  document.getElementById("modalLead").style.display = "block";
};

window.fecharModalLead = () => {
  document.getElementById("modalLead").style.display = "none";
};

window.salvarLeadManual = async () => {
  const nome = document.getElementById("manualNome").value.trim();
  const telefone = document.getElementById("manualTelefone").value.trim();
  const tipo = document.getElementById("manualTipo").value;

  if (!nome) {
    alert("Informe o nome do lead");
    return;
  }

  await addDoc(collection(db, "leads"), {
    nome,
    telefone,
    tipo,
    situacao: "Novo",
    dataCriacao: serverTimestamp()
  });

  fecharModalLead();

  document.getElementById("manualNome").value = "";
  document.getElementById("manualTelefone").value = "";
};

// üî¥ Arquivar lead (Conclu√≠do sem retorno)
window.concluirSemRetorno = async (id) => {
  const ref = doc(db, "leads", id);
  const snap = await getDoc(ref);

  if (!snap.exists()) return;

  // Salva nos arquivados
  await addDoc(collection(db, "leads_arquivados"), {
    ...snap.data(),
    situacao: "Conclu√≠do sem retorno",
    dataArquivamento: serverTimestamp()
  });

  // Remove da lista principal
  await deleteDoc(ref);

  // Atualiza a tela
  carregarLeads();
};
// üîÅ Alternar visualiza√ß√£o
window.alternarArquivados = () => {
  mostrandoArquivados = !mostrandoArquivados;
  carregarLeads();
};

// ‚ôª Restaurar lead arquivado
window.restaurarLead = async (id) => {
  const ref = doc(db, "leads_arquivados", id);
  const snap = await getDoc(ref);

  if (!snap.exists()) return;

  await addDoc(collection(db, "leads"), {
    ...snap.data(),
    situacao: "Novo",
    dataCriacao: serverTimestamp()
  });

  await deleteDoc(ref);

  carregarLeads();
};


</script>

<!-- Rodap√© -->
<footer class="footer">
  <p class="rodape-final">
    ¬© <span id="anoAtual"></span> Desenvolvido por
    <a href="https://github.com/daltonneres" target="_blank" style="color: #fff; text-decoration: none;">
      Dalton Neres - Full Stack Developer
    </a>
    <br>
    Todos os direitos reservados.
  </p>
</footer>

<script>
  document.getElementById("anoAtual").textContent = new Date().getFullYear();
</script>

<div id="modalLead" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:999;">
  <div style="background:#111; max-width:400px; margin:10% auto; padding:20px; border:1px solid #3498db;">
    <h3>Novo Lead Manual</h3>

    <label>Nome</label>
    <input id="manualNome" style="width:100%; padding:8px; margin-bottom:10px;">

    <label>Telefone</label>
    <input id="manualTelefone" style="width:100%; padding:8px; margin-bottom:10px;">

    <label>Tipo</label>
    <select id="manualTipo" style="width:100%; padding:8px; margin-bottom:15px;">
      <option value="Interesse">Interesse</option>
      <option value="Visita">Visita</option>
    </select>

    <div style="display:flex; justify-content:flex-end; gap:10px;">
      <button onclick="fecharModalLead()" class="btn-secondary">Cancelar</button>
      <button onclick="salvarLeadManual()" class="btn-secondary">Salvar</button>
    </div>
  </div>
</div>

</body>
</html>